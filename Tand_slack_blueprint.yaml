blueprint: 
  name: "Rörelsestyrd Belysning med Circual Light – Failsafe Pro 6.8"
  description: >
    En komplett automation för ditt smarta hem som kombinerar rörelsestyrning med avancerade failsafe-funktioner 
    och dynamiskt circadian-ljus. Huvudlampor, dag- och nattlampor, samt circual lights hanteras automatiskt – 
    ljus släcks efter inställd tid, dag- och nattscener återställs, och circadian-ljus anpassas efter solens höjd. 
    Allt loggas för full spårbarhet. Enkel att konfigurera, flexibel och säker för daglig drift.

  domain: automation
  input:
  
    # --- Sensorer & brytare ---
  
    motion_sensors:
      name: Rörelsesensor(er)
      description: "En eller flera rörelsesensorer som ska styra belysningen."
      default: []
      selector:
        entity:
          domain: binary_sensor
          multiple: true

    optional_switches:
      name: Smarta uttag eller strömbrytare
      description: "Valfria smarta uttag eller strömbrytare som kan styra lamporna/enheterna."
      default: []
      selector:
        entity:
          domain: switch
          multiple: true
    
    # --- Lampor & scener ---
    
    main_lights:
      name: Huvudlampor
      description: "Lampor som alltid ska tändas vid rörelse (oavsett dag/natt)."
      default: []
      selector:
        target:
          entity:
            domain: light

    auto_off_main:
      name: Huvudlampors varaktighet (minuter)
      description: "Hur länge huvudlamporna ska lysa efter senaste rörelse."
      default: []
      selector:
        number:
          min: 0
          max: 1200
          step: 1
          unit_of_measurement: min
          mode: box

    scene_day:
      name: Dagscen
      description: "Scen som aktiveras under dagtid (om vald)."
      default: []
      selector:
        entity:
          domain: scene
          multiple: false

    off_scene_day:
      name: Off Scene Dag
      description: "Scen som aktiveras när daglamporna ska stängas av."
      default: []
      selector:
        entity:
          domain: scene
          multiple: false
    
    day_lights:
      name: Dagslampor
      description: "Lampor som bara ska tändas under dagtid."
      default: []
      selector:
        target:
          entity:
            domain: light

    brightness_day:
      name: Dagsljusstyrka
      description: "Valfri ljusstyrka för dagslampor (0–100%). Lämna tomt för default."
      default: null
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
   
    auto_off_day:
      name: Dagslampors varaktighet (minuter)
      description: "Hur länge dagslamporna ska lysa efter senaste rörelse."
      default: []
      selector:
        number:
          min: 0
          max: 1200
          step: 1
          unit_of_measurement: min
          mode: box

    scene_night:
      name: Nattscen
      description: "Scen som aktiveras under nattetid (om vald)."
      default: []
      selector:
        entity:
          domain: scene
          multiple: false

    off_scene_night:
      name: Off Scene Natt
      description: "Scen som aktiveras när nattlamporna ska stängas av."
      default: []
      selector:
        entity:
          domain: scene
          multiple: false
    
    night_lights:
      name: Nattlampor
      description: "Lampor som bara ska tändas under nattetid."
      default: []
      selector:
        target:
          entity:
            domain: light

    brightness_night:
      name: Nattljusstyrka
      description: "Valfri ljusstyrka för nattlampor (0–100%). Lämna tomt för default."
      default: null
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
          
    auto_off_night:
      name: Nattlampors varaktighet (minuter)
      description: "Hur länge nattlamporna ska lysa efter senaste rörelse."
      default: []
      selector:
        number:
          min: 0
          max: 1200
          step: 1
          unit_of_measurement: min
          mode: box
    
    # --- Circadian light ---
    
    circadian_enabled:
      name: Aktivera Circadian
      description: "Om lamporna ska följa circadian-ljusprofil."
      default: false
      selector:
        boolean: {}

    circadian_lights:
      name: Circadian-lampor
      description: "Lampor som ska följa circadian-ljusprofilen."
      default: []
      selector:
        target:
          entity:
            domain: light

    update_interval:
      name: Circadian update interval (min)
      description: "Hur ofta circadian-lampor uppdateras."
      default: 15
      selector:
        number:
          min: 1
          max: 60
          step: 1
          unit_of_measurement: min
    
    circadian_min_temp:
      name: Minimum färgtemperatur (K)
      description: "Färgtemperatur på morgon/natt (varmt ljus)."
      default: 2700
      selector:
        number:
          min: 1500
          max: 6500
          step: 100
          unit_of_measurement: K

    circadian_max_temp:
      name: Maximum färgtemperatur (K)
      description: "Färgtemperatur mitt på dagen (kallt ljus)."
      default: 5000
      selector:
        number:
          min: 1500
          max: 6500
          step: 100
          unit_of_measurement: K
    
    auto_off_circadian:
      name: Circadian-lampors varaktighet (minuter)
      description: "Hur länge circadian-lamporna ska lysa efter senaste rörelse eller trigger."
      default: []
      selector:
        number:
          min: 0
          max: 1200
          step: 1
          unit_of_measurement: min
          mode: box
    
    failsafe_timer_circular:
      name: Failsafe-timer circadian-lampor (minuter)
      description: "Antal minuter innan circadian-lampor automatiskt släcks om auto-off inte har aktiverats."
      default: []
      selector:
        number:
          min: 1
          max: 120
          step: 1
          unit_of_measurement: min
    
    # --- Lux & sol ---
    
    lux_sensor:
      name: Luxsensor
      description: "Sensor som mäter ljusstyrka (lux)."
      default: []
      selector:
        entity:
          domain: sensor
          device_class: illuminance

    lux_threshold:
      name: Luxgräns
      description: "Lampor tänds bara om luxvärdet är lägre än denna gräns."
      default: []
      selector:
        number:
          min: 0
          max: 3000
          step: 1
          unit_of_measurement: lx

    use_sun_times:
      name: Använd soluppgång/solnedgång
      description: "Om automationen ska använda solens tider istället för fasta klockslag."
      default: false
      selector:
        boolean: {}

    sunset_offset:
      name: Offset för solnedgång
      description: "Justering av tiden för solnedgång, tidigare eller senare."
      default: "00:00:00"
      selector:
        time: {}

    sunrise_offset:
      name: Offset för soluppgång
      description: "Justering av tiden för soluppgång, tidigare eller senare."
      default: "00:00:00"
      selector:
        time: {}

    # --- Fasta avstängningstider ---
    
    fixed_off_time_1:
      name: Fast avstängningstid 1 (valfri)
      description: "Klockslag då lampor eller smarta uttag automatiskt släcks/stängs av."
      default: []
      selector:
        time: {}

    fixed_off_weekdays_1:
      name: Aktiva veckodagar (Fast tid 1)
      description: Vilka veckodagar avstängningstid 1 ska gälla.
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Måndag
              value: mon
            - label: Tisdag
              value: tue
            - label: Onsdag
              value: wed
            - label: Torsdag
              value: thu
            - label: Fredag
              value: fri
            - label: Lördag
              value: sat
            - label: Söndag
              value: sun

    fixed_off_time_2:
      name: Fast avstängningstid 2 (valfri)
      description: "Klockslag då lampor eller smarta uttag automatiskt släcks/stängs av."
      default: []
      selector:
        time: {}

    fixed_off_weekdays_2:
      name: Aktiva veckodagar (Fast tid 2)
      description: Vilka veckodagar avstängningstid 2 ska gälla.
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Måndag
              value: mon
            - label: Tisdag
              value: tue
            - label: Onsdag
              value: wed
            - label: Torsdag
              value: thu
            - label: Fredag
              value: fri
            - label: Lördag
              value: sat
            - label: Söndag
              value: sun
    
    # --- Tidinställningar ---
    
    day_start:
      name: Dagsstart
      description: "Tidpunkt då dagsläget aktiveras."
      default: "07:00:00"
      selector:
        time: {}

    day_end:
      name: Dagslut
      description: "Tidpunkt då dagsläget avaktiveras. Dagslut kan inte ha samma starttid som Nattstart. Exempel: 21:59:59 "
      default: "21:59:59"
      selector:
        time: {}

    active_weekdays_day:
      name: Aktiva veckodagar (Dag)
      description: "Välj vilka dagar dagsläget ska vara aktivt."
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Måndag
              value: mon
            - label: Tisdag
              value: tue
            - label: Onsdag
              value: wed
            - label: Torsdag
              value: thu
            - label: Fredag
              value: fri
            - label: Lördag
              value: sat
            - label: Söndag
              value: sun

    night_start:
      name: Nattstart
      description: "Tidpunkt då nattläget aktiveras. Nattstart kan inte ha samma starttid som Dagslut. Exempel: 22:00:00"
      default: "22:00:00"
      selector:
        time: {}

    night_end:
      name: Nattslut
      description: "Tidpunkt då nattläget avaktiveras."
      default: "06:59:59"
      selector:
        time: {}

    active_weekdays_night:
      name: Aktiva veckodagar (Natt)
      description: "Välj vilka dagar nattläget ska vara aktivt."
      default: []
      selector:
        select:
          multiple: true
          options:
            - label: Måndag
              value: mon
            - label: Tisdag
              value: tue
            - label: Onsdag
              value: wed
            - label: Torsdag
              value: thu
            - label: Fredag
              value: fri
            - label: Lördag
              value: sat
            - label: Söndag
              value: sun

    # --- Arbetsdag & failsafe ---
    
    workday_sensor:
      name: Arbetsdagsensor
      description: "Sensor som indikerar arbetsdagar."
      default: []
      selector:
        entity:
          domain: binary_sensor

    enable_failsafe:
      name: Aktivera failsafe
      description: "Slår på failsafe-funktionen som automatiskt släcker lampor om auto-off inte har triggats korrekt."
      default: true
      selector:
        boolean: {}

    failsafe_timer_main:
      name: Failsafe-timer huvudbelysning (minuter)
      description: "Antal minuter innan huvudlampor automatiskt släcks om auto-off inte har aktiverats som förväntat."
      default: []
      selector:
        number:
          min: 1
          max: 240
          step: 1
          unit_of_measurement: min
    
    failsafe_timer_day:
      name: Failsafe-timer dag (minuter)
      description: "Antal minuter innan dagslampor automatiskt släcks om auto-off inte har aktiverats som förväntat."
      default: []
      selector:
        number:
          min: 1
          max: 120
          step: 1
          unit_of_measurement: min

    failsafe_timer_night:
      name: Failsafe-timer natt (minuter)
      description: "Antal minuter innan nattlampor automatiskt släcks om auto-off inte har aktiverats som förväntat."
      default: []
      selector:
        number:
          min: 1
          max: 120
          step: 1
          unit_of_measurement: min

    input_text_last_scene:
      name: Input Text - Senaste scen
      description: "Input Text-enhet som sparar namnet på den senast aktiva scenen."
      default: []
      selector:
        entity:
          domain: input_text

# --- Triggers ---

trigger:
  - platform: state
    entity_id: !input motion_sensors
    to: "on"
    id: motion_on

  - platform: state
    entity_id: !input motion_sensors
    from: "off"
    to: "on"
    id: motion_on
    
  - platform: state
    entity_id: !input motion_sensors
    from: "on"
    to: "off"
    id: motion_off
    
  # --- Optional switches fix ---
  
  - platform: state
    entity_id: !input optional_switches
    to: "on"
    id: switch_on
    
  - platform: state
    entity_id: !input optional_switches
    to: "off"
    id: switch_off
    
  - platform: sun
    event: sunrise
    offset: !input sunrise_offset
    id: sunrise_trigger
    
  - platform: sun
    event: sunset
    offset: !input sunset_offset
    id: sunset_trigger
    
  - platform: time
    at: !input fixed_off_time_1
    id: fixed_off_1
    
  - platform: time
    at: !input fixed_off_time_2
    id: fixed_off_2

  - platform: time_pattern
    minutes: 15  # Intervall för uppdatering, default 15 min
    id: circadian_update

mode: restart

# --- Variabler ---

variables:
  main_lights_var: !input main_lights
  day_lights_var: !input day_lights
  brightness_day_var: !input brightness_day
  night_lights_var: !input night_lights
  brightness_night_var: !input brightness_night
  scene_day_var: !input scene_day
  off_scene_day_var: !input off_scene_day
  scene_night_var: !input scene_night
  off_scene_night_var: !input off_scene_night
  last_scene_entity: !input input_text_last_scene
  lux_sensor_var: !input lux_sensor
  lux_threshold_var: !input lux_threshold
  use_sun_times_var: !input use_sun_times
  workday_sensor_var: !input workday_sensor
  auto_off_main_var: !input auto_off_main
  auto_off_day_var: !input auto_off_day
  auto_off_night_var: !input auto_off_night
  auto_off_circadian_var: !input auto_off_circadian
  fixed_off_weekdays_1_var: !input fixed_off_weekdays_1
  fixed_off_weekdays_2_var: !input fixed_off_weekdays_2
  day_start_var: !input day_start
  day_end_var: !input day_end
  night_start_var: !input night_start
  night_end_var: !input night_end
  active_weekdays_day_var: !input active_weekdays_day
  active_weekdays_night_var: !input active_weekdays_night
  enable_failsafe_var: !input enable_failsafe
  failsafe_timer_main_var: !input failsafe_timer_main
  failsafe_timer_day_var: !input failsafe_timer_day
  failsafe_timer_night_var: !input failsafe_timer_night
  circadian_enabled_var: !input circadian_enabled
  circadian_lights_var: !input circadian_lights
  circadian_min_temp_var: !input circadian_min_temp
  circadian_max_temp_var: !input circadian_max_temp
  failsafe_timer_circular_var: !input failsafe_timer_circular

# --- Actions ---

action:

  # --- Rörelse/Brytare PÅ ---
  
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: motion_on
              - condition: trigger
                id: switch_on
          - condition: template
            value_template: "{{ (optional_switches | default([])) != [] or trigger.id == 'motion_on' }}"
        sequence:

          # --- Snapshot ---
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% set lights = [] %}
                      {% for var in [main_lights_var, day_lights_var, night_lights_var] %}
                        {% if var is string and var != '' %}
                          {% set lights = lights + [var] %}
                        {% elif var is mapping and var.entity_id is string %}
                          {% set lights = lights + [var.entity_id] %}
                        {% elif var is iterable %}
                          {% set lights = lights + var %}
                        {% endif %}
                      {% endfor %}
                      {{ lights | count > 0 }}
                sequence:
                  - service: scene.create
                    data:
                      scene_id: snapshot_before_on
                      snapshot_entities: >
                        {% set lights = [] %}
                        {% for var in [main_lights_var, day_lights_var, night_lights_var] %}
                          {% if var is string and var != '' %}
                            {% set lights = lights + [var] %}
                          {% elif var is mapping and var.entity_id is string %}
                            {% set lights = lights + [var.entity_id] %}
                          {% elif var is iterable %}
                            {% set lights = lights + var %}
                          {% endif %}
                        {% endfor %}
                        {{ lights | tojson }}

          # --- Dagscen ---
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% set t = now().time() %}
                      {% set start = strptime(day_start_var, '%H:%M:%S').time() %}
                      {% set end = strptime(day_end_var, '%H:%M:%S').time() %}
                      {% if start <= end %}
                        {{ t >= start and t <= end }}
                      {% else %}
                        {{ t >= start or t <= end }}
                      {% endif %}
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ scene_day_var | default([]) != [] }}"
                        sequence:
                          - service: scene.turn_on
                            target:
                              entity_id: "{{ scene_day_var }}"
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ day_lights_var | default('') != '' and (lux_sensor_var | default('') == '' or states(lux_sensor_var) | float < lux_threshold_var | float) }}
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: >
                                {% if day_lights_var is string %}
                                  {{ day_lights_var }}
                                {% elif day_lights_var is mapping %}
                                  {{ day_lights_var.entity_id }}
                                {% elif day_lights_var is iterable %}
                                  {{ day_lights_var | join(',') }}
                                {% endif %}
                            data:
                              brightness: >
                                {% if brightness_day_var != '' %}
                                  {{ (brightness_day_var | int * 255 / 100) | int }}
                                {% else %}
                                  255
                                {% endif %}
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ main_lights_var | default('') != '' and (lux_sensor_var | default('') == '' or states(lux_sensor_var) | float < lux_threshold_var | float) }}
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: >
                                {% if main_lights_var is string %}
                                  {{ main_lights_var }}
                                {% elif main_lights_var is mapping %}
                                  {{ main_lights_var.entity_id }}
                                {% elif main_lights_var is iterable %}
                                  {{ main_lights_var | join(',') }}
                                {% endif %}

          # --- Nattscen ---
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% set t = now().time() %}
                      {% set start = strptime(night_start_var, '%H:%M:%S').time() %}
                      {% set end = strptime(night_end_var, '%H:%M:%S').time() %}
                      {% if start <= end %}
                        {{ t >= start and t <= end }}
                      {% else %}
                        {{ t >= start or t <= end }}
                      {% endif %}
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ scene_night_var | default([]) != [] }}"
                        sequence:
                          - service: scene.turn_on
                            target:
                              entity_id: "{{ scene_night_var }}"
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ night_lights_var | default('') != '' and (lux_sensor_var | default('') == '' or states(lux_sensor_var) | float < lux_threshold_var | float) }}
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: >
                                {% if night_lights_var is string %}
                                  {{ night_lights_var }}
                                {% elif night_lights_var is mapping %}
                                  {{ night_lights_var.entity_id }}
                                {% elif night_lights_var is iterable %}
                                  {{ night_lights_var | join(',') }}
                                {% endif %}
                            data:
                              brightness: >
                                {% if brightness_night_var != '' %}
                                  {{ (brightness_night_var | int * 255 / 100) | int }}
                                {% else %}
                                  255
                                {% endif %}
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ main_lights_var | default('') != '' and (lux_sensor_var | default('') == '' or states(lux_sensor_var) | float < lux_threshold_var | float) }}
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: >
                                {% if main_lights_var is string %}
                                  {{ main_lights_var }}
                                {% elif main_lights_var is mapping %}
                                  {{ main_lights_var.entity_id }}
                                {% elif main_lights_var is iterable %}
                                  {{ main_lights_var | join(',') }}
                                {% endif %}

          # --- Spara senaste scen ---
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ last_scene_entity | default('') != '' }}"
                sequence:
                  - service: input_text.set_value
                    data:
                      entity_id: "{{ last_scene_entity }}"
                      value: "Dag/Natt På"

          # --- Loggning ---
          
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Dag/Natt på aktiverad via rörelse eller brytare."

  # --- Auto-off Huvudlampor ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if main_lights_var is string and main_lights_var != '' %}
                {% set lights = [main_lights_var] %}
              {% elif main_lights_var is mapping and main_lights_var.entity_id is string %}
                {% set lights = [main_lights_var.entity_id] %}
              {% elif main_lights_var is iterable %}
                {% set lights = main_lights_var | select('string') | list %}
              {% endif %}
              {{ lights | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ auto_off_main_var | default(0) | float }}"
          - service: light.turn_off
            target:
              entity_id: >
                {% set lights = [] %}
                {% if main_lights_var is string and main_lights_var != '' %}
                  {% set lights = [main_lights_var] %}
                {% elif main_lights_var is mapping and main_lights_var.entity_id is string %}
                  {% set lights = [main_lights_var.entity_id] %}
                {% elif main_lights_var is iterable %}
                  {% set lights = main_lights_var | select('string') | list %}
                {% endif %}
                {{ lights | join(',') }}
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Auto-off Main: Huvudlampor släckta."

  # --- Auto-off Daglampor ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set t = now().time() %}
              {% set start = strptime(day_start_var, '%H:%M:%S').time() %}
              {% set end = strptime(day_end_var, '%H:%M:%S').time() %}
              {% if start <= end %}
                {{ t >= start and t <= end }}
              {% else %}
                {{ t >= start or t <= end }}
              {% endif %}
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if day_lights_var is string and day_lights_var != '' %}
                {% set lights = [day_lights_var] %}
              {% elif day_lights_var is mapping and day_lights_var.entity_id is string %}
                {% set lights = [day_lights_var.entity_id] %}
              {% elif day_lights_var is iterable %}
                {% set lights = day_lights_var | select('string') | list %}
              {% endif %}
              {{ lights | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ auto_off_day_var | default(0) | float }}"
          - service: light.turn_off
            target:
              entity_id: >
                {% set lights = [] %}
                {% if day_lights_var is string and day_lights_var != '' %}
                  {% set lights = [day_lights_var] %}
                {% elif day_lights_var is mapping and day_lights_var.entity_id is string %}
                  {% set lights = [day_lights_var.entity_id] %}
                {% elif day_lights_var is iterable %}
                  {% set lights = day_lights_var | select('string') | list %}
                {% endif %}
                {{ lights | join(',') }}
          - service: scene.turn_on
            target:
              entity_id: scene.snapshot_before_on
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Auto-off Dag: Daglampor släckta och scen återställd."

  # --- Auto-off Nattlampor ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set t = now().time() %}
              {% set start = strptime(night_start_var, '%H:%M:%S').time() %}
              {% set end = strptime(night_end_var, '%H:%M:%S').time() %}
              {% if start <= end %}
                {{ t >= start and t <= end }}
              {% else %}
                {{ t >= start or t <= end }}
              {% endif %}
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if night_lights_var is string and night_lights_var != '' %}
                {% set lights = [night_lights_var] %}
              {% elif night_lights_var is mapping and night_lights_var.entity_id is string %}
                {% set lights = [night_lights_var.entity_id] %}
              {% elif night_lights_var is iterable %}
                {% set lights = night_lights_var | select('string') | list %}
              {% endif %}
              {{ lights | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ auto_off_night_var | default(0) | float }}"
          - service: light.turn_off
            target:
              entity_id: >
                {% set lights = [] %}
                {% if night_lights_var is string and night_lights_var != '' %}
                  {% set lights = [night_lights_var] %}
                {% elif night_lights_var is mapping and night_lights_var.entity_id is string %}
                  {% set lights = [night_lights_var.entity_id] %}
                {% elif night_lights_var is iterable %}
                  {% set lights = night_lights_var | select('string') | list %}
                {% endif %}
                {{ lights | join(',') }}
          - service: scene.turn_on
            target:
              entity_id: scene.snapshot_before_on
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Auto-off Natt: Nattlampor släckta och scen återställd."

  # --- Auto-off Circadian Lights ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if circadian_lights_var is string and circadian_lights_var != '' %}
                {% set lights = [circadian_lights_var] %}
              {% elif circadian_lights_var is mapping and circadian_lights_var.entity_id is string %}
                {% set lights = [circadian_lights_var.entity_id] %}
              {% elif circadian_lights_var is iterable %}
                {% set lights = circadian_lights_var | select('string') | list %}
              {% endif %}
              {{ lights | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ auto_off_circular_var | default(0) | float }}"
          - service: light.turn_off
            target:
              entity_id: >
                {% set lights = [] %}
                {% if circadian_lights_var is string and circadian_lights_var != '' %}
                  {% set lights = [circadian_lights_var] %}
                {% elif circadian_lights_var is mapping and circadian_lights_var.entity_id is string %}
                  {% set lights = [circadian_lights_var.entity_id] %}
                {% elif circadian_lights_var is iterable %}
                  {% set lights = circadian_lights_var | select('string') | list %}
                {% endif %}
                {{ lights | join(',') }}
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Auto-off Circadian: Circadian-lampor släckta."

  # --- Fasta avstängningstider med veckodag ---
  
  - choose:
      - conditions:
          - condition: trigger
            id: fixed_off_1
          - condition: template
            value_template: "{{ now().strftime('%a').lower() in fixed_off_weekdays_1_var }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: >
                {% set lights = [] %}
                {% for var in [main_lights_var, day_lights_var, night_lights_var] %}
                  {% if var | default('') != '' %}
                    {% if var is string %}
                      {% set lights = lights + [var] %}
                    {% elif var is mapping %}
                      {% set lights = lights + [var.entity_id] %}
                    {% elif var is iterable %}
                      {% set lights = lights + var %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {{ lights | join(',') }}

  - choose:
      - conditions:
          - condition: trigger
            id: fixed_off_2
          - condition: template
            value_template: "{{ now().strftime('%a').lower() in fixed_off_weekdays_2_var }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: >
                {% set lights = [] %}
                {% for var in [main_lights_var, day_lights_var, night_lights_var] %}
                  {% if var | default('') != '' %}
                    {% if var is string %}
                      {% set lights = lights + [var] %}
                    {% elif var is mapping %}
                      {% set lights = lights + [var.entity_id] %}
                    {% elif var is iterable %}
                      {% set lights = lights + var %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {{ lights | join(',') }}

  # --- Failsafe Huvudlampor ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_failsafe_var and main_lights_var | default('') != '' }}"
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if main_lights_var is string %}
                {% set lights = [main_lights_var] %}
              {% elif main_lights_var is mapping %}
                {% set lights = [main_lights_var.entity_id] %}
              {% elif main_lights_var is iterable %}
                {% set lights = main_lights_var %}
              {% endif %}
              {{ lights | select('is_state','on') | list | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ failsafe_timer_main_var | default(0) | float }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% set lights = [] %}
                      {% if main_lights_var is string %}
                        {% set lights = [main_lights_var] %}
                      {% elif main_lights_var is mapping %}
                        {% set lights = [main_lights_var.entity_id] %}
                      {% elif main_lights_var is iterable %}
                        {% set lights = main_lights_var %}
                      {% endif %}
                      {{ lights | select('is_state','on') | list | count > 0 }}
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: >
                        {% if main_lights_var is string %}
                          {{ main_lights_var }}
                        {% elif main_lights_var is mapping %}
                          {{ main_lights_var.entity_id }}
                        {% elif main_lights_var is iterable %}
                          {{ main_lights_var | join(',') }}
                        {% endif %}
                  - service: logbook.log
                    data:
                      name: Rörelsestyrning
                      message: "Failsafe Main: Huvudlampor släckta automatiskt (endast om fortfarande på)."

  # --- Failsafe Daglampor ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_failsafe_var }}"
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if day_lights_var is string %}
                {% set lights = [day_lights_var] %}
              {% elif day_lights_var is mapping %}
                {% set lights = [day_lights_var.entity_id] %}
              {% elif day_lights_var is iterable %}
                {% set lights = day_lights_var %}
              {% endif %}
              {{ lights | select('is_state','on') | list | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ failsafe_timer_day_var | default(0) | float }}"
          - service: light.turn_off
            target:
              entity_id: >
                {% if day_lights_var is string %}
                  {{ day_lights_var }}
                {% elif day_lights_var is mapping %}
                  {{ day_lights_var.entity_id }}
                {% elif day_lights_var is iterable %}
                  {{ day_lights_var | join(',') }}
                {% endif %}
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Failsafe Dag: Daglampor släckta automatiskt (endast om fortfarande på)."

      - conditions:
          - condition: template
            value_template: "{{ enable_failsafe_var and scene_day_var | default('') != '' }}"
        sequence:
          - delay:
              minutes: "{{ failsafe_timer_day_var | default(0) | float }}"
          - service: scene.turn_on
            target:
              entity_id: scene.snapshot_before_on
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Failsafe Dag: Dag scen återställd."

  # --- Failsafe Nattlampor ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_failsafe_var }}"
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if night_lights_var is string %}
                {% set lights = [night_lights_var] %}
              {% elif night_lights_var is mapping %}
                {% set lights = [night_lights_var.entity_id] %}
              {% elif night_lights_var is iterable %}
                {% set lights = night_lights_var %}
              {% endif %}
              {{ lights | select('is_state','on') | list | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ failsafe_timer_night_var | default(0) | float }}"
          - service: light.turn_off
            target:
              entity_id: >
                {% if night_lights_var is string %}
                  {{ night_lights_var }}
                {% elif night_lights_var is mapping %}
                  {{ night_lights_var.entity_id }}
                {% elif night_lights_var is iterable %}
                  {{ night_lights_var | join(',') }}
                {% endif %}
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Failsafe Natt: Nattlampor släckta automatiskt (endast om fortfarande på)."

      - conditions:
          - condition: template
            value_template: "{{ enable_failsafe_var and scene_night_var | default('') != '' }}"
        sequence:
          - delay:
              minutes: "{{ failsafe_timer_night_var | default(0) | float }}"
          - service: scene.turn_on
            target:
              entity_id: scene.snapshot_before_on
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Failsafe Natt: Natt scen återställd."

  # --- Circadian Light ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ circadian_enabled_var and circadian_lights_var | default([]) != [] }}"
          - condition: trigger
            id: motion_on
        sequence:
          - service: light.turn_on
            target:
              entity_id: >
                {% if circadian_lights_var is string %}
                  {{ circadian_lights_var }}
                {% elif circadian_lights_var is mapping %}
                  {{ circadian_lights_var.entity_id }}
                {% elif circadian_lights_var is iterable %}
                  {{ circadian_lights_var | join(',') }}
                {% endif %}
            data:
              color_temp: "{{ circadian_temp_var }}"
              brightness: "{{ circadian_brightness_var }}"
          - service: logbook.log
            data:
              name: Rörelsestyrning
              message: "Circadian Lampor: Justerad automatiskt."

  # --- Failsafe Circadian Lights ---
  
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_failsafe_var and circadian_lights_var | default('') != '' }}"
          - condition: template
            value_template: >
              {% set lights = [] %}
              {% if circadian_lights_var is string %}
                {% set lights = [circadian_lights_var] %}
              {% elif circadian_lights_var is mapping %}
                {% set lights = [circadian_lights_var.entity_id] %}
              {% elif circadian_lights_var is iterable %}
                {% set lights = circadian_lights_var %}
              {% endif %}
              {{ lights | select('is_state','on') | list | count > 0 }}
        sequence:
          - delay:
              minutes: "{{ failsafe_timer_circular_var | default(0) | float }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% set lights = [] %}
                      {% if circadian_lights_var is string %}
                        {% set lights = [circadian_lights_var] %}
                      {% elif circadian_lights_var is mapping %}
                        {% set lights = [circadian_lights_var.entity_id] %}
                      {% elif circadian_lights_var is iterable %}
                        {% set lights = circadian_lights_var %}
                      {% endif %}
                      {{ lights | select('is_state','on') | list | count > 0 }}
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: >
                        {% if circadian_lights_var is string %}
                          {{ circadian_lights_var }}
                        {% elif circadian_lights_var is mapping %}
                          {{ circadian_lights_var.entity_id }}
                        {% elif circadian_lights_var is iterable %}
                          {{ circadian_lights_var | join(',') }}
                        {% endif %}
                  - service: logbook.log
                    data:
                      name: Rörelsestyrning
                      message: "Failsafe Circadian lampor: Circadian lampor släckta automatiskt."
